version: '3.8'

services:
  # =====================
  # DATABASE SERVICES
  # =====================
  mysql:
    image: mysql:8.0
    container_name: securepulse-mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./database/seed_data.sql:/docker-entrypoint-initdb.d/seed_data.sql
    networks:
      - securepulse-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: securepulse-phpmyadmin
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    depends_on:
      - mysql
    networks:
      - securepulse-network

  redis:
    image: redis:7.2-alpine
    container_name: securepulse-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - securepulse-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================
  # AI SERVICES
  # =====================
  ollama:
    image: ollama/ollama:latest
    container_name: securepulse-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    networks:
      - securepulse-network

  chromadb:
    image: chromadb/chroma:latest
    container_name: securepulse-chromadb
    restart: unless-stopped
    ports:
      - "8006:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - securepulse-network

  # =====================
  # WAZUH SERVICES
  # =====================
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.0
    container_name: securepulse-wazuh-manager
    restart: unless-stopped
    ports:
      - "1514:1514" # Agent events
      - "1515:1515" # Agent enrollment
      - "55000:55000" # API
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=none
    volumes:
      - wazuh-manager-data:/var/ossec/data
      - wazuh-manager-logs:/var/ossec/logs
      - ./wazuh/config/ossec.conf:/var/ossec/etc/ossec.conf
      - ./wazuh/config/local_rules.xml:/var/ossec/etc/rules/local_rules.xml
    networks:
      - securepulse-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:55000/" ]
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.7.0
    container_name: securepulse-wazuh-indexer
    restart: unless-stopped
    ports:
      - "9200:9200"
    environment:
      - "discovery.type=single-node"
      - "bootstrap.memory_lock=true"
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
    networks:
      - securepulse-network

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.7.0
    container_name: securepulse-wazuh-dashboard
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - WAZUH_API_URL=https://wazuh-manager:55000
      - API_USERNAME=${WAZUH_API_USER}
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    depends_on:
      - wazuh-indexer
      - wazuh-manager
    networks:
      - securepulse-network

  # =====================
  # BACKEND SERVICES
  # =====================
  api-gateway:
    build: ./api-gateway
    container_name: securepulse-api-gateway
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=15m
      - REFRESH_TOKEN_EXPIRES_IN=7d
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - AUTH_SERVICE_URL=http://auth-service:8001
      - INVENTORY_SERVICE_URL=http://inventory-service:8002
      - SOC_SERVICE_URL=http://soc-service:8003
      - AI_SERVICE_URL=http://ai-service:8004
      - REPORTS_SERVICE_URL=http://reports-service:8005
    depends_on:
      - redis
      - auth-service
      - soc-service
    networks:
      - securepulse-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  auth-service:
    build: ./services/auth
    container_name: securepulse-auth-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - mysql
      - redis
    networks:
      - securepulse-network

  inventory-service:
    build: ./services/inventory
    container_name: securepulse-inventory-service
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - DB_HOST=mysql
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - WAZUH_API_URL=https://wazuh-manager:55000
      - WAZUH_API_USER=${WAZUH_API_USER}
      - WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD}
    depends_on:
      - mysql
      - wazuh-manager
    networks:
      - securepulse-network

  soc-service:
    build: ./services/soc
    container_name: securepulse-soc-service
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - DB_HOST=mysql
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - WAZUH_API_URL=https://wazuh-manager:55000
      - WAZUH_API_USER=${WAZUH_API_USER}
      - WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      - mysql
      - redis
      - wazuh-manager
    networks:
      - securepulse-network

  soc-worker:
    build: ./services/soc
    container_name: securepulse-soc-worker
    restart: unless-stopped
    command: celery -A tasks.alert_poller worker --loglevel=info
    environment:
      - DB_HOST=mysql
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - WAZUH_API_URL=https://wazuh-manager:55000
      - WAZUH_API_USER=${WAZUH_API_USER}
      - WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      - redis
      - soc-service
    networks:
      - securepulse-network

  ai-service:
    build: ./services/ai
    container_name: securepulse-ai-service
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_MODEL=llama3.2
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - DB_HOST=mysql
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
    depends_on:
      - ollama
      - chromadb
      - mysql
    networks:
      - securepulse-network

  reports-service:
    build: ./services/reports
    container_name: securepulse-reports-service
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - DB_HOST=mysql
      - DB_NAME=${MYSQL_DATABASE}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    volumes:
      - reports-data:/app/reports
    depends_on:
      - mysql
    networks:
      - securepulse-network

  # =====================
  # FRONTEND
  # =====================
  frontend:
    build: ./frontend
    container_name: securepulse-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5000
      - REACT_APP_WAZUH_DASHBOARD_URL=http://localhost:5601
    depends_on:
      - api-gateway
    networks:
      - securepulse-network

  # =====================
  # REVERSE PROXY
  # =====================
  nginx:
    build: ./nginx
    container_name: securepulse-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - api-gateway
      - wazuh-dashboard
    networks:
      - securepulse-network

networks:
  securepulse-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  ollama-data:
  chroma-data:
  wazuh-manager-data:
  wazuh-manager-logs:
  wazuh-indexer-data:
  reports-data:
